# Plano de Implementa√ß√£o - Ordena√ß√£o Personalizada de Projetos

## üìã Objetivo
Implementar funcionalidade para que cada usu√°rio possa ordenar os projetos no menu lateral como desejar, com persist√™ncia da ordena√ß√£o personalizada.

## üéØ Funcionalidades a Implementar
- Ordena√ß√£o personalizada por drag & drop
- Persist√™ncia da ordena√ß√£o no localStorage
- Ordena√ß√£o padr√£o (alfab√©tica) como fallback
- Interface intuitiva para reordenar
- Manter todas as funcionalidades atuais

## üìä An√°lise da Estrutura Atual

### Arquivos Principais Identificados:
- `src/components/common/Sidebar/ProjectList.jsx` - Lista de projetos
- `src/components/common/Sidebar/ProjectItem.jsx` - Item individual
- `src/selectors/sidebarSelectors.js` - Selectors dos projetos
- `src/reducers/sidebarReducer.js` - Estado do sidebar
- `src/constants/ActionTypes.js` - Tipos de actions

### Estado Atual:
- Projetos s√£o ordenados alfabeticamente por padr√£o
- N√£o h√° persist√™ncia de ordena√ß√£o personalizada
- Interface simples sem drag & drop

## üöÄ Fases de Implementa√ß√£o

### Fase 1: Estrutura de Estado e Persist√™ncia
**Objetivo**: Criar estrutura para armazenar ordena√ß√£o personalizada

**Arquivos a Modificar/Criar**:

#### 1.1. Atualizar ActionTypes
**Arquivo**: `src/constants/ActionTypes.js`
```javascript
// Adicionar novas actions
PROJECTS_ORDER_SAVE: 'PROJECTS_ORDER_SAVE',
PROJECTS_ORDER_LOAD: 'PROJECTS_ORDER_LOAD',
PROJECTS_ORDER_RESET: 'PROJECTS_ORDER_RESET',
```

#### 1.2. Atualizar Sidebar Reducer
**Arquivo**: `src/reducers/sidebarReducer.js`
```javascript
const initialState = {
  isExpanded: false,
  // Nova propriedade para ordena√ß√£o
  projectsOrder: null, // null = ordena√ß√£o padr√£o, array = ordena√ß√£o personalizada
};
```

#### 1.3. Criar Actions do Sidebar
**Arquivo**: `src/actions/sidebarActions.js` (novo arquivo)
```javascript
import ActionTypes from '../constants/ActionTypes';

export const saveProjectsOrder = (order) => ({
  type: ActionTypes.PROJECTS_ORDER_SAVE,
  payload: { order },
});

export const loadProjectsOrder = () => ({
  type: ActionTypes.PROJECTS_ORDER_LOAD,
});

export const resetProjectsOrder = () => ({
  type: ActionTypes.PROJECTS_ORDER_RESET,
});
```

#### 1.4. Atualizar Selectors
**Arquivo**: `src/selectors/sidebarSelectors.js`
```javascript
// Adicionar selector para ordena√ß√£o
export const selectProjectsOrder = (state) => selectSidebarState(state).projectsOrder;

// Modificar selectSidebarProjects para aplicar ordena√ß√£o
export const selectSidebarProjects = createSelector(
  orm,
  (state) => selectCurrentUserId(state),
  (state) => selectProjectsOrder(state),
  ({ User, Board }, userId, customOrder) => {
    // ... l√≥gica existente ...
    
    // Aplicar ordena√ß√£o personalizada se existir
    if (customOrder && customOrder.length > 0) {
      const orderMap = {};
      customOrder.forEach((projectId, index) => {
        orderMap[projectId] = index;
      });
      
      return projectModels
        .slice(0, 50)
        .map((projectModel) => {
          // ... l√≥gica existente ...
        })
        .sort((a, b) => {
          const orderA = orderMap[a.id] !== undefined ? orderMap[a.id] : 999;
          const orderB = orderMap[b.id] !== undefined ? orderMap[b.id] : 999;
          return orderA - orderB;
        });
    }
    
    // Ordena√ß√£o alfab√©tica padr√£o
    return projectModels
      .slice(0, 50)
      .map((projectModel) => {
        // ... l√≥gica existente ...
      })
      .sort((a, b) => a.name.localeCompare(b.name));
  },
);
```

### Fase 2: Interface de Drag & Drop
**Objetivo**: Implementar interface para reordenar projetos

#### 2.1. Instalar Depend√™ncia
```bash
npm install react-beautiful-dnd
```

#### 2.2. Criar Componente de Ordena√ß√£o
**Arquivo**: `src/components/common/Sidebar/ProjectOrderControls.jsx` (novo)
```javascript
import React from 'react';
import PropTypes from 'prop-types';
import { useDispatch, useSelector } from 'react-redux';

import { resetProjectsOrder } from '../../../actions/sidebarActions';
import { selectProjectsOrder } from '../../../selectors/sidebarSelectors';

import styles from './ProjectOrderControls.module.scss';

const ProjectOrderControls = React.memo(() => {
  const dispatch = useDispatch();
  const customOrder = useSelector(selectProjectsOrder);

  const handleResetOrder = () => {
    dispatch(resetProjectsOrder());
  };

  return (
    <div className={styles.wrapper}>
      <div className={styles.controls}>
        <button
          className={styles.resetButton}
          onClick={handleResetOrder}
          type="button"
          title="Restaurar ordena√ß√£o padr√£o"
        >
          <i className="fas fa-sort-alpha-down" />
        </button>
      </div>
    </div>
  );
});

export default ProjectOrderControls;
```

#### 2.3. Estilos para Controles
**Arquivo**: `src/components/common/Sidebar/ProjectOrderControls.module.scss` (novo)
```scss
.wrapper {
  margin-bottom: 8px;
}

.controls {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

.resetButton {
  background: none;
  border: none;
  color: #6c757d;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s ease;
  
  &:hover {
    background-color: #f8f9fa;
    color: #495057;
  }
}
```

#### 2.4. Atualizar ProjectList com Drag & Drop
**Arquivo**: `src/components/common/Sidebar/ProjectList.jsx`
```javascript
import React, { useState, useMemo } from 'react';
import { DragDropContext, Droppable, Draggable } from 'react-beautiful-dnd';
import { useDispatch, useSelector } from 'react-redux';

import ProjectItem from './ProjectItem';
import ProjectOrderControls from './ProjectOrderControls';
import { selectSidebarProjects, selectTotalProjectsCount } from '../../../selectors/sidebarSelectors';
import { saveProjectsOrder } from '../../../actions/sidebarActions';

import styles from './ProjectList.module.scss';

const ProjectList = React.memo(() => {
  const dispatch = useDispatch();
  const projects = useSelector(selectSidebarProjects);
  const totalProjectsCount = useSelector(selectTotalProjectsCount);
  const [showAll, setShowAll] = useState(false);

  const displayedProjects = useMemo(() => {
    if (showAll) {
      return projects;
    }
    return projects.slice(0, 20);
  }, [projects, showAll]);

  const handleDragEnd = (result) => {
    if (!result.destination) {
      return;
    }

    const items = Array.from(displayedProjects);
    const [reorderedItem] = items.splice(result.source.index, 1);
    items.splice(result.destination.index, 0, reorderedItem);

    const newOrder = items.map(item => item.id);
    dispatch(saveProjectsOrder(newOrder));
  };

  const hasMoreProjects = totalProjectsCount > displayedProjects.length;

  if (projects.length === 0) {
    return (
      <div className={styles.wrapper}>
        <h3 className={styles.title}>MEUS PROJETOS</h3>
        <div className={styles.empty}>
          <p>Nenhum projeto encontrado</p>
        </div>
      </div>
    );
  }

  return (
    <div className={styles.wrapper}>
      <h3 className={styles.title}>MEUS PROJETOS</h3>
      <ProjectOrderControls />
      
      <DragDropContext onDragEnd={handleDragEnd}>
        <Droppable droppableId="projects">
          {(provided) => (
            <div
              className={styles.list}
              {...provided.droppableProps}
              ref={provided.innerRef}
            >
              {displayedProjects.map((project, index) => (
                <Draggable
                  key={project.id}
                  draggableId={project.id.toString()}
                  index={index}
                >
                  {(provided, snapshot) => (
                    <div
                      ref={provided.innerRef}
                      {...provided.draggableProps}
                      {...provided.dragHandleProps}
                      className={`${styles.draggableItem} ${
                        snapshot.isDragging ? styles.dragging : ''
                      }`}
                    >
                      <ProjectItem project={project} />
                    </div>
                  )}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
      </DragDropContext>
      
      {hasMoreProjects && (
        <div className={styles.moreProjects}>
          <button
            className={styles.moreButton}
            onClick={() => setShowAll(!showAll)}
            type="button"
          >
            {showAll ? 'Mostrar menos' : `Mostrar mais ${totalProjectsCount - displayedProjects.length} projetos`}
          </button>
        </div>
      )}
    </div>
  );
});

export default ProjectList;
```

#### 2.5. Atualizar Estilos do ProjectList
**Arquivo**: `src/components/common/Sidebar/ProjectList.module.scss`
```scss
// ... estilos existentes ...

.draggableItem {
  transition: transform 0.2s ease;
  
  &.dragging {
    transform: rotate(2deg);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
}

.list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 50px; // Para droppable area
}
```

### Fase 3: Persist√™ncia no localStorage
**Objetivo**: Salvar e carregar ordena√ß√£o automaticamente

#### 3.1. Criar Middleware de Persist√™ncia
**Arquivo**: `src/middleware/projectOrderMiddleware.js` (novo)
```javascript
import ActionTypes from '../constants/ActionTypes';

const STORAGE_KEY = 'planka_projects_order';

export const projectOrderMiddleware = (store) => (next) => (action) => {
  const result = next(action);
  
  switch (action.type) {
    case ActionTypes.PROJECTS_ORDER_SAVE:
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(action.payload.order));
      } catch (error) {
        console.warn('Erro ao salvar ordena√ß√£o:', error);
      }
      break;
      
    case ActionTypes.PROJECTS_ORDER_RESET:
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (error) {
        console.warn('Erro ao remover ordena√ß√£o:', error);
      }
      break;
      
    default:
      break;
  }
  
  return result;
};
```

#### 3.2. Atualizar Store
**Arquivo**: `src/store.js`
```javascript
import { createStore, applyMiddleware, compose } from 'redux';
import { createEpicMiddleware } from 'redux-observable';

import rootReducer from './reducers';
import rootEpic from './sagas';
import { projectOrderMiddleware } from './middleware/projectOrderMiddleware';

// ... c√≥digo existente ...

const epicMiddleware = createEpicMiddleware();

const store = createStore(
  rootReducer,
  compose(
    applyMiddleware(epicMiddleware, projectOrderMiddleware),
    // ... outras configura√ß√µes ...
  ),
);

// ... resto do c√≥digo ...
```

#### 3.3. Carregar Ordena√ß√£o na Inicializa√ß√£o
**Arquivo**: `src/components/common/Sidebar/ProjectList.jsx`
```javascript
import React, { useState, useMemo, useEffect } from 'react';
// ... outros imports ...

const ProjectList = React.memo(() => {
  const dispatch = useDispatch();
  // ... c√≥digo existente ...

  // Carregar ordena√ß√£o na inicializa√ß√£o
  useEffect(() => {
    const savedOrder = localStorage.getItem('planka_projects_order');
    if (savedOrder) {
      try {
        const order = JSON.parse(savedOrder);
        dispatch({ type: ActionTypes.PROJECTS_ORDER_LOAD, payload: { order } });
      } catch (error) {
        console.warn('Erro ao carregar ordena√ß√£o:', error);
        localStorage.removeItem('planka_projects_order');
      }
    }
  }, [dispatch]);

  // ... resto do c√≥digo ...
});
```

### Fase 4: Melhorias de UX
**Objetivo**: Adicionar feedback visual e melhorar experi√™ncia

#### 4.1. Atualizar ProjectItem com Indicadores de Drag
**Arquivo**: `src/components/common/Sidebar/ProjectItem.jsx`
```javascript
// Adicionar indicador visual de que o item √© arrast√°vel
const ProjectItem = React.memo(({ project }) => {
  // ... c√≥digo existente ...

  return (
    <div
      className={classNames(styles.wrapper, {
        [styles.hasNotifications]: project.hasNotifications,
        [styles.draggable]: true, // Indicar que √© arrast√°vel
      })}
      onClick={handleClick}
      role="button"
      tabIndex={0}
    >
      <div className={styles.content}>
        <div className={styles.dragHandle}>
          <i className="fas fa-grip-vertical" />
        </div>
        <span className={styles.name}>{project.name}</span>
        {project.hasNotifications && (
          <NotificationIndicator />
        )}
      </div>
    </div>
  );
});
```

#### 4.2. Estilos para Drag Handle
**Arquivo**: `src/components/common/Sidebar/ProjectItem.module.scss`
```scss
// ... estilos existentes ...

.draggable {
  cursor: grab;
  
  &:active {
    cursor: grabbing;
  }
}

.dragHandle {
  color: #adb5bd;
  margin-right: 8px;
  opacity: 0.6;
  transition: opacity 0.2s ease;
  
  &:hover {
    opacity: 1;
  }
}

.content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}
```

### Fase 5: Tratamento de Erros e Fallbacks
**Objetivo**: Garantir robustez da funcionalidade

#### 5.1. Valida√ß√£o de Ordena√ß√£o
**Arquivo**: `src/selectors/sidebarSelectors.js`
```javascript
// Fun√ß√£o auxiliar para validar ordena√ß√£o
const validateProjectOrder = (order, projectIds) => {
  if (!Array.isArray(order)) return null;
  
  // Verificar se todos os IDs na ordena√ß√£o existem nos projetos
  const validOrder = order.filter(id => projectIds.includes(id));
  
  // Adicionar projetos que n√£o est√£o na ordena√ß√£o
  const missingProjects = projectIds.filter(id => !validOrder.includes(id));
  
  return [...validOrder, ...missingProjects];
};

export const selectSidebarProjects = createSelector(
  orm,
  (state) => selectCurrentUserId(state),
  (state) => selectProjectsOrder(state),
  ({ User, Board }, userId, customOrder) => {
    // ... l√≥gica existente ...
    
    const projectModels = userModel.getProjectsModelArray();
    const projectIds = projectModels.map(pm => pm.id);
    
    // Validar ordena√ß√£o personalizada
    const validOrder = customOrder ? validateProjectOrder(customOrder, projectIds) : null;
    
    if (validOrder && validOrder.length > 0) {
      const orderMap = {};
      validOrder.forEach((projectId, index) => {
        orderMap[projectId] = index;
      });
      
      return projectModels
        .slice(0, 50)
        .map((projectModel) => {
          // ... l√≥gica existente ...
        })
        .sort((a, b) => {
          const orderA = orderMap[a.id] !== undefined ? orderMap[a.id] : 999;
          const orderB = orderMap[b.id] !== undefined ? orderMap[b.id] : 999;
          return orderA - orderB;
        });
    }
    
    // Ordena√ß√£o alfab√©tica padr√£o
    return projectModels
      .slice(0, 50)
      .map((projectModel) => {
        // ... l√≥gica existente ...
      })
      .sort((a, b) => a.name.localeCompare(b.name));
  },
);
```

## üìÅ Estrutura Final de Arquivos

```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ common/
‚îÇ       ‚îî‚îÄ‚îÄ Sidebar/
‚îÇ           ‚îú‚îÄ‚îÄ ProjectList.jsx (modificado)
‚îÇ           ‚îú‚îÄ‚îÄ ProjectList.module.scss (modificado)
‚îÇ           ‚îú‚îÄ‚îÄ ProjectItem.jsx (modificado)
‚îÇ           ‚îú‚îÄ‚îÄ ProjectItem.module.scss (modificado)
‚îÇ           ‚îú‚îÄ‚îÄ ProjectOrderControls.jsx (novo)
‚îÇ           ‚îî‚îÄ‚îÄ ProjectOrderControls.module.scss (novo)
‚îú‚îÄ‚îÄ actions/
‚îÇ   ‚îî‚îÄ‚îÄ sidebarActions.js (novo)
‚îú‚îÄ‚îÄ selectors/
‚îÇ   ‚îî‚îÄ‚îÄ sidebarSelectors.js (modificado)
‚îú‚îÄ‚îÄ reducers/
‚îÇ   ‚îî‚îÄ‚îÄ sidebarReducer.js (modificado)
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îî‚îÄ‚îÄ projectOrderMiddleware.js (novo)
‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îî‚îÄ‚îÄ ActionTypes.js (modificado)
‚îî‚îÄ‚îÄ store.js (modificado)
```

## üõ°Ô∏è Considera√ß√µes de Seguran√ßa

1. **Valida√ß√£o de Dados**: Validar ordena√ß√£o antes de aplicar
2. **Fallback Seguro**: Sempre ter ordena√ß√£o alfab√©tica como fallback
3. **Tratamento de Erros**: Capturar erros de localStorage
4. **Performance**: Limitar n√∫mero de projetos ordenados
5. **Compatibilidade**: Manter funcionalidades existentes

## üéØ Crit√©rios de Sucesso

- [ ] Usu√°rios podem reordenar projetos por drag & drop
- [ ] Ordena√ß√£o √© persistida no localStorage
- [ ] Ordena√ß√£o √© carregada automaticamente
- [ ] Bot√£o para restaurar ordena√ß√£o padr√£o funciona
- [ ] Interface √© intuitiva e responsiva
- [ ] Todas as funcionalidades existentes s√£o mantidas
- [ ] Performance n√£o √© afetada
- [ ] Tratamento de erros robusto

## üöÄ Pr√≥ximos Passos

1. **Implementar Fase 1**: Estrutura de estado e persist√™ncia
2. **Testar cada fase** individualmente
3. **Validar funcionalidade** ap√≥s cada implementa√ß√£o
4. **Documentar mudan√ßas** realizadas
5. **Testar em diferentes navegadores**

## üìù Notas Importantes

- **Backup obrigat√≥rio** antes de cada modifica√ß√£o
- **Testar incrementalmente** cada funcionalidade
- **Manter padr√µes** do projeto existente
- **Documentar mudan√ßas** para futuras manuten√ß√µes
- **Considerar performance** com muitos projetos
